# Copy On Write는 어떤 방식으로 동작하는지 설명하시오.

## 값 타입과 참조타입
- 스위프트에는 타입에는 크게 값(value) 타입, 참조(reference) 타입이 있습니다.
- 일반적으로 값 타입은 메모리의 영역 중 스택(stack), 참조 타입은 힙(heap) 영역에 할당되는 것으로 알려져 있습니다.
- 각 타입이 다른 변수에 할당이 되는 경우 힙 영역의 존재하는 참조타입(class, closure)은 참조 카운팅 등 고려할 요소가 많기 때문에 실제 값을 복사하기보다는 원본 타입에 대한 참조만 발생하고, 값 타입은 실제 값에 대한 복사가 일어나 같은 값을 지니는 또 하나의 변수가 만들어집니다.

## 그래서 Copy-On-Write가 뭔데?
- collection들(Set, Array, Dictionary, String)은 구조체이기에 값 타입이지만 가변적인 길이를 가지기 때문에 내부의 데이터는 실제로 힙에 저장하고 있습니다. 이유는 컴파일 타임에 정확한 크기를 예측할 수 없기 때문에, 힙에 할당 후  그 크기를 증감시킨다고 하네요.
- 이때, collection들은 우리가 알고 있는 값 타입의 복사라면 다른 값에 할당될 시 내부의 값의 실제 복사가 일어나겠죠? 그렇다면 RC등 많은 참조 계산 오버헤드 때문에 엄청나게 많은 메모리가 소모될 껍니다.
- 이를 방지하기 위해 컬렉션의 복사는 참조타입과 동일하게 실제 사본을 생성하지 않고 원본에 대한 참조를 수행합니다. `변화가 일어나기 전까지`
- 여기서 말하는 변화란 참조하고 있는 원본이나 할당된 변수에 수정/삭제/추가가 발생한 시점 이후로,  참조가 아닌 원래 값 타입의 방식대로 `깊은 복사`를 수행합니다.

## 어차피 복사할껀데 무슨 의미가 있지?
- 변수를 읽기전용으로만 사용할 예정이라면 메모리 많이 아낄 수 있습니다. 실제 값의 수정이 필요하지도 않은데  `깊은 복사`가 발생하면 메모리 낭비가 심하기 때문이죠.

## 부록
#### Q : String의 경우 예외로 짧은 문자열(길이 15이하)은 스택에 저장되고 실제로 짧은 문자열에서  [실험](https://forestjae.tistory.com/30)해보니 메모리 주소가 달라요! 그럼 짧은 문자열은 copy-on-write가 발생하지 않는건가요?

### A : 아닙니다. 실험에서 다르다고 확인된 주소는 사실 스택의 주소입니다. 문자열의 경우 짧은 문자열은 스택에 공간이 할당되는 것은 맞는 말이지만, 사실 힙 영역 내부  `MALLOC_TINY`  영역에도 저장된다고 하네요. 실험에서처럼  `str2`  에  `str1`  을 할당하면 다른 스택 영역을 주소로 사용하게 되나, 힙 영역은  `MALLOC_TINY`  의   `str1`이 저장된 주소와 같은 주소를 사용하게 됩니다. 이때 문자열에 변화를 가하게 되면 그제서야 새로운 힙 영역 주소를 사용하게 되면서 copy-on-write가 발생할 것입니다.

## 참고 링크
- [swift의 타입과 메모리 저장 공간](https://sujinnaljin.medium.com/ios-swift%EC%9D%98-type%EA%B3%BC-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%A0%80%EC%9E%A5-%EA%B3%B5%EA%B0%84-25555c69ccff)
- [Copy on Write in Swift](https://medium.com/@nitingeorge_39047/copy-on-write-in-swift-b44949436e4f)
